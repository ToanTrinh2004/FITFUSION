const {
    GoogleGenerativeAI,
    HarmCategory,
    HarmBlockThreshold,
  } = require("@google/generative-ai");
  const fs = require("node:fs");
  const mime = require("mime-types");
  
  const apiKey = process.env.GEMINI_API_KEY;
  const genAI = new GoogleGenerativeAI(apiKey);
  
  const model = genAI.getGenerativeModel({
    model: "gemini-2.5-pro-exp-03-25",
  });
  
  const generationConfig = {
    temperature: 1,
    topP: 0.95,
    topK: 64,
    maxOutputTokens: 65536,
    responseModalities: [
    ],
    responseMimeType: "text/plain",
  };
  
  async function run() {
    const chatSession = model.startChat({
      generationConfig,
      history: [
        {
          role: "user",
          parts: [
            {text: "prompt = `A person has a BMI status of \"${bmiStatus}, food allergy${foodAllergy}, favorite food${foodFavour\n}\". Generate a daily meal plan (breakfast, lunch, and dinner). \n    Each meal should include:\n    - Dish name\n    - Ingredients\n    - Instructions\n    - Calories\n    - Macronutrients (protein, carbs, fats)\n    - A short note on why it's beneficial for this BMI category.`;"},
          ],
        },
        {
          role: "model",
          parts: [
            {text: "Here's a thinking process that leads to the meal plan generation:\n\n1.  **Understand the Goal:** The request is to generate a *daily* meal plan (Breakfast, Lunch, Dinner) for a person based on their BMI status, food allergies, and favorite foods. Each meal needs specific details: dish name, ingredients, instructions, calories, macronutrients, and a justification related to the BMI status.\n\n2.  **Identify the Variables:** The prompt uses placeholders:\n    *   `\"${bmiStatus}\"`\n    *   `\"${foodAllergy}\"`\n    *   `\"${foodFavour}\"` (Note the typo, likely meant \"favorite\")\n\n3.  **Recognize the Need for Concrete Examples:** The prompt is a *template*. To generate a useful meal plan, I need actual values for these variables. I can't generate a plan for `\"bmiStatus\"` in general; I need to know *which* status (e.g., Underweight, Healthy Weight, Overweight, Obese). Similarly, I need specific allergies and favorite foods.\n\n4.  **Strategy: Provide a Template with Placeholders and an Example:**\n    *   **Acknowledge the template nature:** Start by explaining that the prompt is a template and needs specific inputs.\n    *   **Create the structure:** Outline the meal plan structure (Breakfast, Lunch, Dinner) with all the required fields for *each* meal.\n    *   **Populate with placeholders:** Fill in the structure using placeholders like `[Dish Name]`, `[List of Ingredients]`, `[Step-by-step Instructions]`, `[Approximate Calories]`, `[Protein value]g Protein, [Carbs value]g Carbs, [Fats value]g Fats`, and `[BMI Benefit Note]`.\n    *   **Address the variables:** Explicitly mention how `bmiStatus`, `foodAllergy`, and `foodFavour` would influence the *actual* content of these placeholders.\n        *   `bmiStatus`: Affects calorie/macro targets, portion sizes, and the *type* of justification note. (e.g., weight gain for underweight, maintenance/loss for overweight/obese).\n        *   `foodAllergy`: Requires *excluding* specific ingredients. This is critical.\n        *   `foodFavour`: Should be *incorporated* where possible and healthy, making the plan more enjoyable and sustainable.\n    *   **Provide a Concrete Example:** To make it practical, choose a sample set of inputs (e.g., BMI: Overweight, Allergy: Peanuts, Favorite: Chicken) and generate a full meal plan based on those. This demonstrates *how* the template would be used.\n\n5.  **Pre-computation/Pre-analysis (for the example):**\n    *   **Inputs Chosen:**\n        *   `bmiStatus`: Overweight\n        *   `foodAllergy`: Peanuts\n        *   `foodFavour`: Chicken\n    *   **General Strategy for \"Overweight\":** Focus on nutrient-dense, lower-calorie meals, controlled portions, high fiber, adequate protein (for satiety), and complex carbohydrates. Avoid excessive fats and simple sugars. Aim for a moderate calorie deficit (implicit in the meal choices).\n    *   **Allergy Consideration:** Absolutely no peanuts or peanut products (including peanut oil if specified or as a precaution). Check cross-contamination risks in instructions if applicable.\n    *   **Favorite Food Integration:** Include chicken in at least one meal, prepared healthily (e.g., grilled, baked, not fried).\n    *   **Meal Ideas (Drafting):**\n        *   *Breakfast:* Something filling, protein/fiber-rich. Oatmeal with fruit and nuts (avoid peanuts!), or eggs with veggies and whole-wheat toast. Let's go with Oatmeal.\n        *   *Lunch:* Lean protein + veggies + complex carbs. A salad with grilled chicken? Or a chicken stir-fry? Let's do a large salad with grilled chicken.\n        *   *Dinner:* Lean protein + lots of veggies. Baked fish with roasted vegetables? Or maybe another chicken dish, prepared differently? Let's use chicken again (favorite food) but baked/roasted. Baked Chicken Breast with Roasted Vegetables.\n    *   **Refining Meal Details (Example):**\n        *   *Breakfast (Oatmeal):* Rolled oats, water/milk (specify low-fat?), berries, seeds (chia/flax), maybe a *different* nut (almonds/walnuts - check if allergy extends beyond peanuts). *Calorie/Macro Estimation:* Need approximate values. Oatmeal ~150, milk ~50, berries ~50, seeds/nuts ~100 = ~350 kcal. Good carbs, some protein/fat. *BMI Note:* Fiber/protein for satiety, controlled calories.\n        *   *Lunch (Chicken Salad):* Grilled chicken breast, mixed greens, cucumber, tomatoes, bell peppers, light vinaigrette. *Calorie/Macro Estimation:* Chicken ~150-200, veggies ~50, dressing ~50-100 = ~300-350 kcal. High protein, low carb/fat (depending on dressing). *BMI Note:* Lean protein, high volume/low cal veggies for fullness.\n        *   *Dinner (Baked Chicken & Veggies):* Chicken breast, broccoli, carrots, bell peppers, olive oil, herbs. *Calorie/Macro Estimation:* Chicken ~150-200, veggies ~100, oil ~50 = ~300-350 kcal. High protein, moderate carbs/fats. *BMI Note:* Lean protein, fiber-rich veggies, portion control.\n    *   **Reviewing Example against Requirements:** Does each meal have all parts? Yes. Are calories/macros plausible (rough estimates are okay for an example)? Yes. Is the allergy addressed? Yes (no peanuts). Is the favorite food included? Yes (chicken twice). Is the BMI justification relevant? Yes (focus on satiety, lower calories, nutrients for overweight).\n\n6.  **Format the Output:** Present the template clearly first, then the example. Use formatting (like bolding, bullet points) to make it readable. Add necessary disclaimers (consult professionals, calorie/macro estimates).\n\n7.  **Final Polish:** Read through the entire response. Check for clarity, consistency, and tone. Ensure the explanation of how the variables affect the plan is clear. Make sure the example logically follows the chosen inputs. Fix the \"foodFavour\" typo in the explanation if possible, or just work with it."},
            {text: "Okay, this prompt is a template. To generate a *specific* meal plan, I need actual values for `bmiStatus`, `foodAllergy`, and `foodFavour`.\n\nHowever, I can provide you with the **structure and an example** of how this would work.\n\n**First, here's the template structure you requested:**\n\n---\n\n**Daily Meal Plan**\n\n*   **BMI Status:** `${bmiStatus}`\n*   **Food Allergy:** `${foodAllergy}` (Note: All ingredients will avoid this)\n*   **Favorite Food:** `${foodFavour}` (Note: We'll try to incorporate this healthily)\n\n---\n\n**Breakfast**\n\n*   **Dish Name:** [Breakfast Dish Name - e.g., Oatmeal with Berries and Seeds]\n*   **Ingredients:**\n    *   [Ingredient 1 (Quantity)]\n    *   [Ingredient 2 (Quantity)]\n    *   [Ingredient 3 (Quantity)]\n    *   ... (Ensure no `${foodAllergy}` items)\n*   **Instructions:**\n    1.  [Step 1]\n    2.  [Step 2]\n    3.  [Step 3]\n*   **Approximate Calories:** [Number] kcal\n*   **Approximate Macronutrients:**\n    *   Protein: [Number]g\n    *   Carbohydrates: [Number]g\n    *   Fats: [Number]g\n*   **BMI Benefit Note:** [Explain why this meal is suitable for the `${bmiStatus}` category - e.g., \"Provides sustained energy and fiber for satiety, aiding weight management for an 'Overweight' status.\"]\n\n---\n\n**Lunch**\n\n*   **Dish Name:** [Lunch Dish Name - e.g., Grilled Chicken Salad with Vinaigrette]\n*   **Ingredients:**\n    *   [Ingredient 1 (Quantity)]\n    *   [Ingredient 2 (Quantity)]\n    *   [Ingredient 3 (Quantity)]\n    *   ... (Ensure no `${foodAllergy}` items; potentially include `${foodFavour}` if suitable)\n*   **Instructions:**\n    1.  [Step 1]\n    2.  [Step 2]\n    3.  [Step 3]\n*   **Approximate Calories:** [Number] kcal\n*   **Approximate Macronutrients:**\n    *   Protein: [Number]g\n    *   Carbohydrates: [Number]g\n    *   Fats: [Number]g\n*   **BMI Benefit Note:** [Explain why this meal is suitable for the `${bmiStatus}` category - e.g., \"Lean protein supports muscle maintenance, while high vegetable volume offers nutrients with fewer calories, beneficial for an 'Obese' status.\"]\n\n---\n\n**Dinner**\n\n*   **Dish Name:** [Dinner Dish Name - e.g., Baked Salmon with Roasted Vegetables]\n*   **Ingredients:**\n    *   [Ingredient 1 (Quantity)]\n    *   [Ingredient 2 (Quantity)]\n    *   [Ingredient 3 (Quantity)]\n    *   ... (Ensure no `${foodAllergy}` items; potentially include `${foodFavour}` if suitable)\n*   **Instructions:**\n    1.  [Step 1]\n    2.  [Step 2]\n    3.  [Step 3]\n*   **Approximate Calories:** [Number] kcal\n*   **Approximate Macronutrients:**\n    *   Protein: [Number]g\n    *   Carbohydrates: [Number]g\n    *   Fats: [Number]g\n*   **BMI Benefit Note:** [Explain why this meal is suitable for the `${bmiStatus}` category - e.g., \"Nutrient-dense with healthy fats and protein, supporting healthy weight gain for an 'Underweight' status.\"]\n\n---\n**Disclaimer:** *Calorie and macronutrient values are estimates. Portion sizes should be adjusted based on individual daily caloric needs. This plan is a suggestion and not a substitute for professional medical or nutritional advice, especially considering food allergies.*\n\n---\n\n**Now, let's fill this template with a hypothetical example:**\n\n*   **`bmiStatus` = \"Overweight\"**\n*   **`foodAllergy` = \"Shellfish\"**\n*   **`foodFavour` = \"Pasta\"**\n\n---\n\n**Example Daily Meal Plan**\n\n*   **BMI Status:** Overweight\n*   **Food Allergy:** Shellfish (Note: All ingredients will avoid shellfish)\n*   **Favorite Food:** Pasta (Note: We'll incorporate this healthily in moderation)\n\n---\n\n**Breakfast**\n\n*   **Dish Name:** Greek Yogurt with Berries and Almonds\n*   **Ingredients:**\n    *   1 cup (220g) Plain Greek Yogurt (0% or 2% fat)\n    *   1/2 cup (75g) Mixed Berries (fresh or frozen)\n    *   1 tbsp (10g) Sliced Almonds\n    *   Optional: 1 tsp Chia seeds\n*   **Instructions:**\n    1.  Spoon Greek yogurt into a bowl.\n    2.  Top with mixed berries.\n    3.  Sprinkle almonds and chia seeds (if using) over the top.\n*   **Approximate Calories:** 280 kcal\n*   **Approximate Macronutrients:**\n    *   Protein: 25g\n    *   Carbohydrates: 25g\n    *   Fats: 9g\n*   **BMI Benefit Note:** High protein content promotes satiety, helping control appetite. Low glycemic index carbs from berries provide steady energy. Portion-controlled fats. Beneficial for managing weight in the 'Overweight' category.\n\n---\n\n**Lunch**\n\n*   **Dish Name:** Large Mixed Greens Salad with Grilled Chicken\n*   **Ingredients:**\n    *   4 oz (115g) Boneless, Skinless Chicken Breast\n    *   3 cups Mixed Salad Greens (lettuce, spinach, arugula)\n    *   1/2 cup Cherry Tomatoes, halved\n    *   1/2 Cucumber, sliced\n    *   1/4 Red Onion, thinly sliced\n    *   2 tbsp Light Vinaigrette Dressing (e.g., olive oil, lemon juice, herbs)\n    *   Salt, Pepper, Herbs (for chicken)\n*   **Instructions:**\n    1.  Season chicken breast with salt, pepper, and desired herbs. Grill or pan-sear until cooked through (165°F/74°C internal temperature). Let rest, then slice.\n    2.  Combine mixed greens, tomatoes, cucumber, and red onion in a large bowl.\n    3.  Top the salad with the sliced grilled chicken.\n    4.  Drizzle with light vinaigrette dressing just before serving.\n*   **Approximate Calories:** 350 kcal\n*   **Approximate Macronutrients:**\n    *   Protein: 35g\n    *   Carbohydrates: 15g\n    *   Fats: 18g\n*   **BMI Benefit Note:** Lean protein source (chicken) aids fullness and muscle retention during weight management. High volume of low-calorie vegetables provides fiber and nutrients, contributing to satiety without excess calories, suitable for the 'Overweight' category.\n\n---\n\n**Dinner**\n\n*   **Dish Name:** Whole Wheat Pasta Primavera (incorporating favorite food)\n*   **Ingredients:**\n    *   1.5 oz (45g dry weight, approx 1 cup cooked) Whole Wheat Pasta\n    *   1 cup Mixed Vegetables (e.g., broccoli florets, bell pepper strips, zucchini slices, peas)\n    *   2 cloves Garlic, minced\n    *   1 tbsp Olive Oil\n    *   1/4 cup Low-Sodium Vegetable Broth or Pasta Water\n    *   2 tbsp Grated Parmesan Cheese\n    *   Salt, Pepper, Red Pepper Flakes (optional)\n*   **Instructions:**\n    1.  Cook whole wheat pasta according to package directions. Reserve 1/4 cup pasta water before draining.\n    2.  While pasta cooks, heat olive oil in a large skillet over medium heat. Add minced garlic and cook until fragrant (about 30 seconds).\n    3.  Add mixed vegetables and sauté until tender-crisp (about 5-7 minutes). Add red pepper flakes if desired.\n    4.  Add the cooked pasta, reserved pasta water (or broth), and Parmesan cheese to the skillet. Toss well to combine. Season with salt and pepper to taste.\n    5.  Serve immediately.\n*   **Approximate Calories:** 400 kcal\n*   **Approximate Macronutrients:**\n    *   Protein: 18g\n    *   Carbohydrates: 60g\n    *   Fats: 12g\n*   **BMI Benefit Note:** Incorporates the favorite food (pasta) using a whole wheat version for higher fiber, promoting better blood sugar control and satiety. Packed with vegetables for nutrients and volume. Portion control is key, making it a balanced meal suitable for weight management within the 'Overweight' category.\n\n---\n**Disclaimer:** *Calorie and macronutrient values are estimates. Portion sizes should be adjusted based on individual daily caloric needs. This plan is a suggestion and not a substitute for professional medical or nutritional advice, especially considering food allergies.*\n\n---\n\nTo get a truly personalized plan, please provide the specific `bmiStatus`, `foodAllergy`, and `foodFavour` you have in mind!"},
          ],
        },
      ],
    });
  
    const result = await chatSession.sendMessage("INSERT_INPUT_HERE");
    const candidates = result.response.candidates;
    for(let candidate_index = 0; candidate_index < candidates.length; candidate_index++) {
      for(let part_index = 0; part_index < candidates[candidate_index].content.parts.length; part_index++) {
        const part = candidates[candidate_index].content.parts[part_index];
        if(part.inlineData) {
          try {
            const filename = `output_${candidate_index}_${part_index}.${mime.extension(part.inlineData.mimeType)}`;
            fs.writeFileSync(filename, Buffer.from(part.inlineData.data, 'base64'));
            console.log(`Output written to: ${filename}`);
          } catch (err) {
            console.error(err);
          }
        }
      }
    }
    console.log(result.response.text());
  }
  
  run();